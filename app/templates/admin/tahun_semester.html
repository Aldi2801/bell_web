{% extends "layout.html" %}

{% block form_tambah %}
<div class="col-md-12 mb-3">
  <label for="tahun_akademik">Tahun Akademik</label>
  <select class="form-select" name="tahun_id" id="tahun_akademik" required>
    <option value="">-- Pilih Tahun Akademik --</option>
    {% for t in thn_akademik %}
    <option value="{{ t.id_tahun_akademik }}">{{ t.tahun_akademik }}</option>
    {% endfor %}
  </select>
</div>

<div class="col-md-12 mb-3">
  <label for="semester">Semester</label>
  <select class="form-select" name="semester_id" id="semester" required>
    <option value="">-- Pilih Semester --</option>
    {% for s in semester %}
    <option value="{{s.id_semester}}">{{s.semester}}</option>
    {% endfor %}
  </select>
</div>

<div class="col-md-12 mb-3">
  <label for="mulai">Tanggal Mulai</label>
  <input type="date" class="form-control" name="mulai" id="mulai" required>
</div>

<div class="col-md-12 mb-3">
  <label for="sampai">Tanggal Sampai</label>
  <input type="date" class="form-control" name="sampai" id="sampai" required>
</div>
{% endblock %}

{% block content %}

<div class="page-titles">
  <div class="row">
    <div class="col-lg-8 col-md-6 col-12 align-self-center">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb mb-0 d-flex align-items-center">
          <li class="breadcrumb-item">
            <a href="index.html" class="link">
              <i class="ri-home-3-line fs-5"></i>
            </a>
          </li>
          <li class="breadcrumb-item active" aria-current="page">{{title_data}}</li>
        </ol>
      </nav>
      <h1 class="mb-0 fw-bold">Data {{title}}</h1>
    </div>
    {% if btn_tambah %}
    <div class="col-lg-4 col-md-6 d-md-flex align-items-center justify-content-end">
      <button type="button" class="btn btn-info d-flex align-items-center ms-2" class="logout-button"
        data-bs-toggle="modal" data-bs-target="#tambahModal">
        <i class="ri-add-line me-1"></i> Tambah Data
      </button>
    </div>
    {% endif %}
  </div>
</div>
<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <!-- templates/crud/semester.html -->
          <h4>Data Semester serta Tahun Akademik</h4>
          <div class="table-responsive">
            <table id="myTable" class="table table-striped">
              <thead class="table-info">
                <tr>
                  <th>Tahun Akademik</th>
                  <th>Semester</th>
                  <th>Mulai</th>
                  <th>Sampai</th>
                  <th>Aksi</th>
                </tr>
              </thead>
              <tbody>
                {% for ts in data %}
                <tr>
                    <td>{{ ts.tahun_akademik}}</td>
                    <td>{{ ts.semester}}</td>
                    <td>{{ ts.mulai}}</td>
                    <td>{{ ts.sampai}}</td>
                  <td>
                    <button type="button" class="btn btn-warning"
                      onclick="openEditModal('{{ ts.id }}')">Edit</button>
                    <button type="button" class="btn btn-danger"
                      onclick="deleteData('{{ ts.id }}')">Hapus</button>
                  </td>
                </tr>
                <!-- Modal Edit -->
                <div class="modal fade" id="editModal-{{ ts.id }}" tabindex="-1" aria-labelledby="editLabel"
                  aria-hidden="true">
                  <div class="modal-dialog  modal-lg">
                    <div class="modal-content">

                      <!-- Modal Header -->
                      <div class="modal-header">
                        <h5 class="modal-title" id="editLabel">Edit {{title_data}}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Tutup"></button>
                      </div>

                      <!-- Modal Body -->
                      <div class="modal-body">
                      <form id="editForm-{{ ts.id }}">
                        <input type="hidden" name="id" value="{{ ts.id }}">

                        <div class="mb-3">
                          <label for="edit_tahun_akademik_{{ ts.id }}">Tahun Akademik</label>
                          <select class="form-select" name="tahun_id" id="edit_tahun_akademik_{{ ts.id }}" required>
                            {% for t in thn_akademik %}
                            <option value="{{ t.id_tahun_akademik }}" {% if t.tahun_akademik == ts.tahun_akademik %}selected{% endif %}>
                              {{ t.tahun_akademik }}
                            </option>
                            {% endfor %}
                          </select>
                        </div>

                        <div class="mb-3">
                          <label for="edit_semester_{{ ts.id }}">Semester</label>
                          <select class="form-select" name="semester_id" id="edit_semester_{{ ts.id }}" required>
                            {% for s in semester %}
                            <option value="{{s.id_semester}}" {% if ts.semester_id == s.id_semester %}selected{% endif %}>{{s.semester}}</option>
                            {% endfor %}
                          </select>
                        </div>

                        <div class="mb-3">
                          <label for="edit_mulai_{{ ts.id }}">Tanggal Mulai</label>
                          <input type="date" class="form-control" name="mulai" id="edit_mulai_{{ ts.id }}"
                                value="{{ ts.mulai.strftime('%Y-%m-%d') if ts.mulai else '' }}" required>
                        </div>

                        <div class="mb-3">
                          <label for="edit_sampai_{{ ts.id }}">Tanggal Sampai</label>
                          <input type="date" class="form-control" name="sampai" id="edit_sampai_{{ ts.id }}"
                                value="{{ ts.sampai.strftime('%Y-%m-%d') if ts.sampai else '' }}" required>
                        </div>

                        <div class="modal-footer">
                          <button type="submit" id="tombol-edit-{{ ts.id }}" class="btn btn-success">Simpan</button>
                          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                        </div>
                      </form>
                    </div>

                    </div>
                  </div>
                </div>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
  $('#myTable').DataTable({
    order: [[0, 'desc']] // kolom pertama DESC
  });
  document.addEventListener('input', function (e) {
    if (e.target && e.target.name === 'nama_semester') {
      const value = e.target.value.trim ? e.target.value.trim() : e.target.value;
      const regexHuruf = /^[A-Za-z]{0,6}$/;

      if (!regexHuruf.test(value)) {
        e.target.classList.add("is-invalid");
      } else {
        e.target.classList.remove("is-invalid");
      }
    }
  });
</script>
{% for ts in data %}
<script>
  // AJAX for Edit Semester (PUT)

  document.getElementById("editForm-{{ ts.id }}").addEventListener("submit", function (event) {
    event.preventDefault();
    const form = this;
    const formData = new FormData(form);
    const data = {};
    let isValid = true;
    let firstInvalid = null;

    // Cek tiap elemen yang required
    [...form.elements].forEach(input => {
      if (input.hasAttribute("required")) {
        const value = input.value.trim ? input.value.trim() : input.value;
        if (!value) {
          isValid = false;
          firstInvalid = firstInvalid || input;
          input.classList.add("is-invalid");
        } else {
          input.classList.remove("is-invalid");
        }
      }
    });

    // Jika tidak valid, kasih alert dan fokus ke input pertama yang kosong
    if (!isValid) {
      alert("Harap lengkapi semua field yang wajib diisi.");
      firstInvalid && firstInvalid.focus();
      return;
    }
    const namaSemesterInput = form.querySelector("[name='nama_semester']");
    formData.forEach((value, key) => {
      data[key] = value.trim ? value.trim() : value;
    });
    const tombol = document.getElementById("tombol-edit-{{ ts.id }}");
    tombol.disabled = true;
    tombol.innerHTML = '<div class="spinner-border spinner-border-sm"></div>';
    const baseUrl = window.location.origin + window.location.pathname;
    $.ajax({
      url: baseUrl + '/edit/{{ ts.id }}',
      type: 'PUT',
      contentType: 'application/json',
      dataType: 'json',
      data: JSON.stringify(data),
      xhrFields: {
        withCredentials: true
      },
      success: function (response) {
        tombol.innerHTML = "Simpan";
        tombol.disabled = false;
        alert(response.msg || "Berhasil update semester");
        window.location.reload();
      },
      error: function (xhr, status, error) {
        tombol.innerHTML = "Simpan";
        tombol.disabled = false;
        var errorTxt = "Server Error";
        if (xhr.responseJSON && xhr.responseJSON.error) {
          errorTxt = xhr.responseJSON.error;
        }
        if (xhr.responseJSON && xhr.responseJSON.msg) {
          errorTxt = xhr.responseJSON.msg;
        }
        alert(`Edit failed: ${errorTxt}`);
      }
    });
  });
</script>
{% endfor %}
{% endblock %}