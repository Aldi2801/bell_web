{% extends 'include/include.html' %}
{% block content %}
<div class="page-titles">
  <div class="row">
    <div class="col-lg-8 col-md-6 col-12 align-self-center">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb mb-0 d-flex align-items-center">
          <li class="breadcrumb-item">
            <a href="index.html" class="link">
              <i class="ri-home-3-line fs-5"></i>
            </a>
          </li>
          <li class="breadcrumb-item active" aria-current="page">Tambah Data Penerimaan Barang</li>
        </ol>
      </nav>
      <h1 class="mb-0 fw-bold">Tambah Data Penerimaan Barang</h1>
    </div>
    <div class="col-lg-4 col-md-6 d-md-flex align-items-center justify-content-end">
      
    </div>
  </div>
</div>

<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="card">

        <div class="card-body">
            <div class="mt-3">
              <h4>Tambah Data</h4>
                <div class="form-group"> <label for="tglfaktur">Tanggal Faktur </label> <input disabled type="date" id="tglfaktur" value="{{tanggal}}" class="form-control"> </div>
                <div class="form-group"> <label for="nofaktur">Nomor Faktur</label> <input type="text" id="nofaktur" class="form-control"> </div>
                <div class="form-group"> 
                <label for="supplier">Principle / Supplier</label> 
                <select class=" form-control select2" style="width: 100%; height: 36px" id="supplier" name="supplier">
                {% for i in data_pabrik %}
                <option value="{{ i.id }}">{{ i.nama_supplier }}</option>
                {% endfor %}
                </select>
                </div>
                <div class="form-group"> <label for="alamatpabrik">Alamat</label> <input disabled type="text" id="alamatpabrik" class="form-control"> </div>
                <div class="form-group"> <label for="tlppabrik">Telepon </label> <input disabled type="text" id="tlppabrik" class="form-control"> </div>
                
                <div class="email-repeater mb-3">
                  <div data-repeater-list="repeater-group">
                    <div data-repeater-item class="row mb-3 bg-light border-top mt-4">
                      <div class="form-group"> <label for="nmbarang">Nama Barang</label> 
                          <select class=" form-control select2 nmbarang" style="width: 100%; height: 36px" id="nmbarang">
                          {% for i in data_barang %}
                          <option value="{{i.id}}">{{i.nama_barang}} | {{i.kode_barang}}</option>
                          {% endfor %}
                          </select>
                      </div>
                      <div class="form-group"> <label for="kdbarang">Kode Barang</label> <input disabled type="text" id="kdbarang" class="kdbarang form-control"> </div>
                      <div class="form-group"> <label for="qty">Quantity</label> <input disabled type="text" id="qty" class="qty form-control"> </div>
                      <div class="form-group"> <label for="jmlpenerimaan">Jumlah Penerimaan</label> <input type="number"placeholder="0" min="0" id="jmlpenerimaan" class="jmlpenerimaan form-control"> </div>
                      <div class="form-group row mt-3"> 
                          <label for="hargasatuan" class="col-sm-2 col-form-label">Harga Satuan</label>
                          <div class="col-sm-10">
                          <div class="input-group">
                              <div class="input-group-prepend">
                              <span class="input-group-text">Rp</span>
                              </div>
                              <input type="text" placeholder="0"  oninput="formatAngkaInput(this)" id="hargasatuan" class="hargasatuan form-control">
                              <div class="input-group-append">
                              <span class="input-group-text">,00</span>
                              </div>
                          </div>
                          </div>
                      </div>
                      <div class="form-group row"><label for="hargatotal" class="col-sm-2 col-form-label">Harga Total</label>
                        <div class="col-sm-10">
                            <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text">Rp</span>
                            </div>
                            <input disabled type="text" placeholder="0" id="hargatotal" class="hargatotal form-control">
                            <div class="input-group-append">
                                <span class="input-group-text">,00</span>
                            </div>
                            </div>
                        </div>
                      </div>
                      <div class="form-group"> <label for="pembayaran">Metode Pembayaran</label>
                        <select id="pembayaran" class="pembayaran form-select"> 
                            <option value="Cash">Cash</option>
                            <option value="Tempo">Tempo</option>
                        </select>
                      </div>
                      <div class="form-group"> <label for="jthtempo">Jatuh Tempo</label> <input  type="date"  id="jthtempo" class="jthtempo form-control"> </div>
                      <div class="form-group"> <label for="tglpembayaran">Tanggal Pembayaran</label> <input  type="date"  id="tglpembayaran" class="tglpembayaran form-control"> </div>
                      <div class="form-group"> <label for="ket">Keterangan Pembayaran</label> <input  type="text"  id="ket" class="ket form-control"> </div>
                      <div class="form-group"> <label for="lunas_or_no">Lunas / Tidak Lunas</label> 
                        <select id="lunas_or_no" class="lunas_or_no form-select"> 
                            <option value="Lunas">Lunas</option>
                            <option value="Tidak Lunas">Tidak Lunas </option>
                        </select>
                      </div>                      
                      <div>
                      <button data-repeater-delete="" class="mt-3 btn btn-danger waves-effect waves-light w-100" type="button" >
                        <div class="d-flex align-items-center">
                          <i data-feather="x-circle" class="feather-sm ms-2 pr-2 fill-white"></i> Hapus Barang
                        </div>
                      </button>
                      </div>
                    </div>
                  </div>
                  <button type="button" data-repeater-create="" id="tambah-barang" class="btn btn-info w-100 waves-effect waves-light">
                  <div class="d-flex align-items-center">
                    <i data-feather="plus-circle" class="feather-sm ms-2 pr-2 fill-white"></i>
                    Tambah Barang
                  </div>
                  </button>
                </div>

                <div class="text-end mt-3">
         <button id="modal-submit-tambah"class="btn btn-info ms-2">Submit</button>
        <a href="/admin/penerimaan" class="btn btn-secondary" >Back</a>
      </div>
            </div>
        </div>
        
                
      </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block js %}
  <!-- This Page JS -->
  <script src="../../static/assets/libs/select2/dist/js/select2.full.min.js"></script>
  <script src="../../static/assets/libs/select2/dist/js/select2.min.js"></script>
  <script src="../../static/dist/js/pages/forms/select2/select2.init.js"></script>
  <script src="../../static/assets/libs/jquery.repeater/jquery.repeater.min.js"></script>
  <script src="../../static/assets/extra-libs/jquery.repeater/repeater-init.js"></script>
  <script src="../../static/assets/extra-libs/jquery.repeater/dff.js"></script>
  <script>
  
function bersihkanFormatAngka(input) {
  input = input.replace(/\./g, ''); // hapus semua titik
  return input
}

function formatAngkaInput(el) {
  let angka = el.value.replace(/\./g, "");
  el.value = formatAngka(angka);
}

function formatAngka(angka) {
	angka = angka.toString()
  let number_string = angka.replace(/[^,\d]/g, "").toString();
  let split = number_string.split(",");
  let sisa = split[0].length % 3;
  let hasil = split[0].substr(0, sisa);
  let ribuan = split[0].substr(sisa).match(/\d{3}/g);

  if (ribuan) {
    let separator = sisa ? "." : "";
    hasil += separator + ribuan.join(".");
  }

  return hasil;
}
    $("#supplier").change(function() {
      console.log("Event change pada #supplier dipicu");

      try {
        if (!'{{ data_pabrik | tojson | safe }}') {
          console.warn("Data pabrik is undefined or null.");
          return;
        }
        var data_pabrik = JSON.parse('{{ data_pabrik | tojson | safe }}');
        var nama_pabrik = $('#supplier').val();

        var found = false; // Untuk melacak apakah pabrik ditemukan
        for (var key in data_pabrik) {
          var nama = data_pabrik[key].id;

          if (nama == nama_pabrik) {
            $('#alamatpabrik').val(data_pabrik[key].alamat);
            $('#tlppabrik').val(data_pabrik[key].tlp);
            found = true;
            break; // Keluar dari loop jika pabrik ditemukan
          }
        }

        if (!found) {
          console.warn("pabrik tidak ditemukan. Mengosongkan alamat dan tlp pabrik.");
          $('#alamatpabrik').val("");
          $('#tlppabrik').val("");
        }
      } catch (error) {
        console.error("Error saat memproses perubahan nama pabrik:", error);
      }
    });

    setInterval(function() {
      $(".jmlpenerimaan, .hargasatuan").trigger("input");
      $(".hpp").trigger("input");
    }, 3000);

    $(document).on("change", ".nmbarang", function() {
      if (!'{{ data_barang | tojson | safe }}') {
        console.warn("Data barang is undefined or null.");
        return;
      }
      var data_barang1 = JSON.stringify({{ data_barang | tojson | safe }});
      var data_barang = JSON.parse(data_barang1);
      var $row = $(this).closest("[data-repeater-item]"); // Get the current row
      var id_barang = $(this).val();
      var found = false; // Untuk melacak apakah barang ditemukan
      for (var key in data_barang) {
        var id = data_barang[key].id;
        if (id == id_barang) {
          $row.find('.kdbarang').val(data_barang[key].kode_barang);
          $row.find('.qty').val(data_barang[key].qty);
          found = true;
          break; // Keluar dari loop jika barang ditemukan
        }
      }
      if (!found) {
        console.warn("Barang tidak ditemukan. Mengosongkan id barang, qty, dan alamat barang.");
        $row.find('.idbarang').val("");
        $row.find('.qty').val("");
        $row.find('.alamatbarang').val(""); // Clear alamatbarang
      }
    });

    $(document).on("input", ".jmlpenerimaan, .hargasatuan", function() {
     
        var $row = $(this).closest("[data-repeater-item]"); // Get the current row
        var jumlah = $row.find('.jmlpenerimaan').val();
        var harga_satuan = $row.find('.hargasatuan').val();
        if (!jumlah || !harga_satuan) {
          console.warn("Jumlah atau harga satuan kosong. Tidak dapat menghitung harga total.");
          $row.find(".hargatotal").val("");
        }
		harga_satuan = bersihkanFormatAngka(harga_satuan);
        var jml = parseFloat(jumlah) * parseFloat(harga_satuan);
        console.log("Harga total:", jml);
		jml = formatAngka(jml)
		console.log(jml)
        $row.find(".hargatotal").val(jml);
      
    });

    $("#modal-submit-tambah").click(function() {
      // Siapkan data untuk dikirim berdasarkan kategori
      const data = {
        tglfaktur: $("#tglfaktur").val(),
        nofaktur: $("#nofaktur").val(),
        id_supplier: $("#supplier").val(),
        items: [] // Array untuk menyimpan data dari repeater
      };
      // Iterasi melalui elemen repeater untuk mengumpulkan data
      $("[data-repeater-item]").each(function() {
        const item = {
          id_barang: $(this).find("#nmbarang").val() || "",
          jml_menerima: $(this).find("#jmlpenerimaan").val() || "",
          harga_satuan: bersihkanFormatAngka($(this).find("#hargasatuan").val()) || "",
          harga_total: bersihkanFormatAngka($(this).find("#hargatotal").val()) || "",
          pembayaran: $(this).find("#pembayaran").val() || "",
          jthtempo: $(this).find("#jthtempo").val() || "",
          tglpembayaran: $(this).find("#tglpembayaran").val() || "",
          lunas_or_no: $(this).find("#lunas_or_no").val() || "",
          ket: $(this).find("#ket").val() || "",
        };
        data.items.push(item); // Tambahkan item ke array
      });
      $.ajax({
        url: '/admin/penerimaan/tambah/id',
        method: 'POST',
        data: JSON.stringify(data),
        contentType: 'application/json',
        headers: { 'Authorization': 'Bearer ' + "{{ session['jwt_token'] }}" },
        success: function(response) {
          alert("Tambah Data Penerimaan Sukses");
          location.href = "/admin/penerimaan";
        },
        error: function(xhr, status, error) {
          console.error("Error:", error);
          if (xhr.responseJSON && xhr.responseJSON.error) {
            let errorMessages = xhr.responseJSON.error;
            alert("Validation Errors:\n" + errorMessages);
          } else {
            alert("An unexpected error occurred: " + error);
          }
        }
      });
    });
  $("#tambah-barang").on("click", function() {
    console.log("halol");
    setTimeout(function() {
      $(".nmbarang").change();
      $(".nmbarang").select2();
      $('span[data-select2-id="3"]').hide();
      const observer = new MutationObserver(function(mutationsList, observer) {
        const element = document.querySelector('span[data-select2-id="5"]');
        if (element) {
          element.style.display = 'none';
          observer.disconnect(); // Hentikan observer setelah elemen ditemukan
        }
      });
      observer.observe(document.body, { childList: true, subtree: true });
    }, 1000);
  });
  </script>
{% endblock %}
