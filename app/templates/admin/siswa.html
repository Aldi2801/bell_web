{% extends "layout.html" %}
{% block form_tambah %}

<div class="row">
    <div class="col-md-6 mb-3">
        <label for="nis">NIS</label>
        <input type="number" class="form-control" id="nis" name="nis" placeholder="NIS" required >
    </div>
    <div class="col-md-6 mb-3">
        <label for="nisn">NISN</label>
        <input type="text" class="form-control" id="nisn" name="nisn" placeholder="NISN" required maxlength="10" pattern="[0-9]{0,10}" title="Masukkan 10 digit angka NISN">
    </div>
    <div class="col-md-6 mb-3">
        <label for="nama">Nama</label>
        <input type="text" class="form-control" id="nama" name="nama" placeholder="Nama" required maxlength="255" title="Nama lengkap siswa">
    </div>
    <div class="col-md-6 mb-3">
        <label for="username_tambah">Username</label>
        <input type="text" class="form-control" autocomplete="off" id="username_tambah" placeholder="username" name="username_tambah" required maxlength="255" title="Username untuk login siswa">
    </div>
    <div class="col-md-6 mb-3">
        <label for="id_gender">Gender</label>
        <select class="form-control form-select" id="id_gender" name="id_gender" required>
            <option value="">Pilih Gender</option>
            {% for g in gender_list %}
            <option value="{{ g.id_gender }}">{{ g.gender }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="col-md-6 mb-3">
        <label for="tempat_lahir">Tempat Lahir</label>
        <input type="text" class="form-control" id="tempat_lahir" name="tempat_lahir" placeholder="Tempat Lahir" required maxlength="20" title="Tempat lahir siswa">
    </div>
    <div class="col-md-6 mb-3">
        <label for="tanggal_lahir">Tanggal Lahir</label>
        <input type="date" class="form-control" id="tanggal_lahir" name="tanggal_lahir" placeholder="Tanggal Lahir" required >
    </div>
    <div class="col-md-6 mb-3">
        <label for="alamat">Alamat</label>
        <input type="text" class="form-control" id="alamat" name="alamat" placeholder="Alamat" required maxlength="125" title="Alamat lengkap siswa">
    </div>
    <div class="col-md-6 mb-3">
        <label for="no_hp">No HP</label>
        <input type="tel" class="form-control" id="no_hp" name="no_hp" placeholder="No HP" required maxlength="15" pattern="[0-9]{10,15}" title="Masukkan no HP antara 10â€“15 digit angka">
    </div>
    <div class="col-md-6 mb-3">
        <label for="email">Email</label>
        <input type="email" class="form-control" id="email" name="email" placeholder="Email" required autocomplete="off" maxlength="255" title="Email untuk login siswa">
    </div>
    <div class="col-md-6 mb-3">
        <label for="asal_sekolah">Asal Sekolah</label>
        <input type="text" class="form-control" id="asal_sekolah" name="asal_sekolah" placeholder="Asal Sekolah" required maxlength="30" title="Nama sekolah asal siswa">
    </div>
    <div class="col-md-6 mb-3">
        <label for="nama_ayah">Nama Ayah</label>
        <input type="text" class="form-control" id="nama_ayah" name="nama_ayah" placeholder="Nama Ayah" required maxlength="35" title="Nama ayah">
    </div>
    <div class="col-md-6 mb-3">
        <label for="nama_ibu">Nama Ibu</label>
        <input type="text" class="form-control" id="nama_ibu" name="nama_ibu" placeholder="Nama Ibu" required  maxlength="35" title="Nama ibu">
    </div>
    <div class="col-md-6 mb-3">
        <label for="penghasilan_ayah">Penghasilan Ayah</label>
        <input type="number" class="form-control" id="penghasilan_ayah" name="penghasilan_ayah" placeholder="Penghasilan Ayah" required min="0" title="Penghasilan ayah (dalam angka)">
    </div>
    <div class="col-md-6 mb-3">
        <label for="penghasilan_ibu">Penghasilan Ibu</label>
        <input type="number" class="form-control" id="penghasilan_ibu" name="penghasilan_ibu" placeholder="Penghasilan Ibu" required min="0" title="Penghasilan ibu (dalam angka)">
    </div>
    <div class="col-md-6 mb-3">
        <label for="id_status">Status</label>
        <select class="form-control form-select" id="id_status" name="id_status" required>
            <option value="">Pilih Status</option>
            {% for s in status_list %}
            <option value="{{ s.id_status }}">{{ s.status }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="col-md-6 mb-3">
        <label for="password_tambah">Password</label>
        <input type="password" class="form-control" autocomplete="off" id="password_tambah" name="password_tambah" placeholder="password" required maxlength="255" title="Password untuk login siswa">
    </div>
</div>

{% endblock %}

{% block content %}

<div class="page-titles">
  <div class="row">
    <div class="col-lg-8 col-md-6 col-12 align-self-center">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb mb-0 d-flex align-items-center">
          <li class="breadcrumb-item">
            <a href="index.html" class="link">
              <i class="ri-home-3-line fs-5"></i>
            </a>
          </li>
          <li class="breadcrumb-item active" aria-current="page">Data {{title}}</li>
        </ol>
      </nav>
      <h1 class="mb-0 fw-bold">Data {{title}}</h1>
    </div>
	{% if btn_tambah %}
    <div class="col-lg-4 col-md-6 d-md-flex align-items-center justify-content-end">
    <form id="uploadExcelForm" action="/admin/siswa/tambah_excell" method="POST" enctype="multipart/form-data" style="display: inline;">
      <input type="file" id="excelInput" name="file" accept=".xls,.xlsx" style="display: none;" onchange="document.getElementById('uploadExcelForm').submit();">
      <button type="button" class="btn btn-success d-flex align-items-center ms-2" onclick="document.getElementById('excelInput').click();">
        <i class="ri-add-line me-1"></i> Tambah Banyak Data Lewat Excel
      </button>
    </form>
		<button type="button" class="btn btn-info d-flex align-items-center ms-2" class="logout-button" data-bs-toggle="modal" data-bs-target="#tambahModal">
		  <i class="ri-add-line me-1"></i> Tambah Data
		</button>
    </div>
    {% endif %}
  </div>
</div>
<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
<!-- templates/crud/semester.html -->
<h4>Data Semester</h4>
<div class="table-responsive">
<table id="myTable" class="table table-striped" >
    <thead class="table-info">
        <tr>
            <th>No</th>
            <th>Img Profile</th>
                        <th>NIS</th>
                        <th>NISN</th>
                        <th>Nama Lengkap</th>
                        <th>Username</th>
                        <th>Gender</th>
                        <th>Tempat Lahir</th>
                        <th>Tanggal Lahir</th>
                        <th>Alamat</th>
                        <th>No HP</th>
                        <th>Email</th>
                        <th>Nama Ayah</th>
                        <th>Nama Ibu</th>
                        <th>Penghasilan Ayah</th>
                        <th>Penghasilan Ibu</th>
                        <th>Asal Sekolah</th>
                        <th>Status</th>
                        <th>Aksi</th>
        </tr>
    </thead>
    <tbody>
           {% for s in siswa_list %}
                <tr>
                        <td>{{loop.index}}</td>
                        <td><img src="/static/img_profile/{{s.user.img_profile}}" width="50px" height="50px" class="img img-responsive card " alt="Image Profile {{s.nama}}" ></td>
                        <td>{{ s.nis }}</td>
                        <td>{{ s.nisn }}</td>
                        <td>{{ s.nama }}</td>
                        <td>{{ s.user.username }}</td>
                        <td>{{ s.gender_rel.gender }}</td>
                        <td>{{ s.tempat_lahir }}</td>
                        <td style="white-space: nowrap;">{{ s.tanggal_lahir.strftime("%d-%m-%Y") }}</td>
                        <td>{{ s.alamat }}</td>
                        <td>{{ s.no_hp }}</td>
                        <td>{{ s.user.email }}</td>
                        <td>{{ s.nama_ayah }}</td>
                        <td>{{ s.nama_ibu }}</td>
                        <td>{{ s.penghasilan_ayah }}</td>
                        <td>{{ s.penghasilan_ibu }}</td>
                        <td>{{ s.asal_sekolah }}</td>
                        <td>{{ s.status_rel.status }}</td>
                        <td style="white-space: nowrap;">
                        <div class="d-flex gap-2">
                                <button type="button" class="btn btn-warning" onclick="openEdit('{{ s.nis }}')">Edit</button>
                                <button type="button" class="btn btn-danger" onclick="deleteData('{{ s.nis }}')">Hapus</button>
                        </div>
                        </td>
                </tr>
                <!-- Modal Edit -->
				<div id="editModal-{{ s.nis }}"class="modal fade"  tabindex="-1" aria-labelledby="editLabel" aria-hidden="true">
				  <div class="modal-dialog">
					<div class="modal-content">
					  <!-- Modal Header -->
					  <div class="modal-header">
						<h5 class="modal-title" id="tambahTagihanLabel">Edit {{title_data}}</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Tutup"></button>
					  </div>	
					<div class="modal-body">
					  <form id="editForm-{{ s.nis }}" enctype="multipart/form-data">
						<input type="hidden" name="nis_old" value="{{ s.nis }}">
            
						<div class="mb-2 row">
						  <label for="nis_{{ s.nis }}" class="col-sm-4 col-form-label">NIS</label>
						  <div class="col-sm-8">
							<input type="number" id="nis_{{ s.nis }}" name="nis" value="{{ s.nis }}" class="form-control" required >
						  </div>
						</div>

						<div class="mb-2 row">
						  <label for="nisn_{{ s.nis }}" class="col-sm-4 col-form-label">NISN</label>
						  <div class="col-sm-8">
							<input type="text" id="nisn_{{ s.nis }}" name="nisn" value="{{ s.nisn }}" class="form-control" maxlength="10" pattern="[0-9]{0,10}" title="Masukkan 10 digit angka NISN">
						  </div>
						</div>

						<div class="mb-2 row">
						  <label for="nama_{{ s.nis }}" class="col-sm-4 col-form-label">Nama</label>
						  <div class="col-sm-8">
							<input type="text" id="nama_{{ s.nis }}" name="nama" value="{{ s.nama }}" class="form-control" required maxlength="255" title="Nama lengkap siswa">
						  </div>
						</div>

						<div class="mb-2 row">
						  <label for="id_gender_{{ s.nis }}" class="col-sm-4 col-form-label">Gender</label>
						  <div class="col-sm-8">
							<select name="id_gender" id="id_gender_{{ s.nis }}" class="form-control form-select" required>
							  {% for g in gender_list %}
							  <option value="{{ g.id_gender }}" {% if s.id_gender == g.id_gender %}selected{% endif %}>{{ g.gender }}</option>
							  {% endfor %}
							</select>
						  </div>
						</div>

						<div class="mb-2 row">
						  <label for="tempat_lahir_{{ s.nis }}" class="col-sm-4 col-form-label">Tempat Lahir</label>
						  <div class="col-sm-8">
							<input type="text" id="tempat_lahir_{{ s.nis }}" name="tempat_lahir" value="{{ s.tempat_lahir }}" class="form-control" required maxlength="20" title="Tempat lahir siswa">
						  </div>
						</div>

						<div class="mb-2 row">
						  <label for="tanggal_lahir_{{ s.nis }}" class="col-sm-4 col-form-label">Tanggal Lahir</label>
						  <div class="col-sm-8">
							<input type="date" id="tanggal_lahir_{{ s.nis }}" name="tanggal_lahir" value="{{ s.tanggal_lahir }}" class="form-control" required>
						  </div>
						</div>

						<div class="mb-2 row">
						  <label for="alamat_{{ s.nis }}" class="col-sm-4 col-form-label">Alamat</label>
						  <div class="col-sm-8">
							<input type="text" id="alamat_{{ s.nis }}" name="alamat" value="{{ s.alamat }}" class="form-control" required maxlength="125" title="Alamat lengkap siswa">
						  </div>
						</div>

						<div class="mb-2 row">
						  <label for="no_hp_{{ s.nis }}" class="col-sm-4 col-form-label">No HP</label>
						  <div class="col-sm-8">
							<input type="text" id="no_hp_{{ s.nis }}" name="no_hp" value="{{ s.no_hp }}" class="form-control" required maxlength="15" pattern="[0-9]{10,15}" title="Masukkan no HP antara 10â€“15 digit angka">
						  </div>
						</div>

						<div class="mb-2 row">
						  <label for="username_{{ s.nis }}" class="col-sm-4 col-form-label">Username</label>
						  <div class="col-sm-8">
							<input type="text" id="username_{{ s.nis }}" name="username" value="{{ s.user.username }}" class="form-control" required autocomplete="off" maxlength="255" title="Username untuk login siswa">
						  </div>
						</div>


						<div class="mb-2 row">
						  <label for="password_{{ s.nis }}" class="col-sm-4 col-form-label">Password</label>
						  <div class="col-sm-8">
							<input type="password" id="password_{{ s.nis }}" name="password" class="form-control" autocomplete="off" maxlength="255" title="Password untuk login siswa">
						  </div>
						</div>

						<div class="mb-2 row">
						  <label for="email_{{ s.nis }}" class="col-sm-4 col-form-label">Email</label>
						  <div class="col-sm-8">
							<input type="email" id="email_{{ s.nis }}" name="email" value="{{ s.user.email }}" class="form-control" required autocomplete="off" maxlength="255" title="Email untuk login siswa">
						  </div>
						</div>

						<div class="mb-2 row">
						  <label for="nama_ayah_{{ s.nis }}" class="col-sm-4 col-form-label">Nama Ayah</label>
						  <div class="col-sm-8">
							<input type="text" id="nama_ayah_{{ s.nis }}" name="nama_ayah" value="{{ s.nama_ayah }}" class="form-control" required maxlength="35" title="Nama ayah">
						  </div>
						</div>

						<div class="mb-2 row">
						  <label for="nama_ibu_{{ s.nis }}" class="col-sm-4 col-form-label">Nama Ibu</label>
						  <div class="col-sm-8">
							<input type="text" id="nama_ibu_{{ s.nis }}" name="nama_ibu" value="{{ s.nama_ibu }}" class="form-control" required maxlength="35" title="Nama ibu">
						  </div>
						</div>

						<div class="mb-2 row">
						  <label for="penghasilan_ayah_{{ s.nis }}" class="col-sm-4 col-form-label">Penghasilan Ayah</label>
						  <div class="col-sm-8">
							<input type="number" id="penghasilan_ayah_{{ s.nis }}" name="penghasilan_ayah" value="{{ s.penghasilan_ayah }}" class="form-control" required min="0" title="Penghasilan ayah (dalam angka)">
						  </div>
						</div>

						<div class="mb-2 row">
						  <label for="penghasilan_ibu_{{ s.nis }}" class="col-sm-4 col-form-label">Penghasilan Ibu</label>
						  <div class="col-sm-8">
							<input type="number" id="penghasilan_ibu_{{ s.nis }}" name="penghasilan_ibu" value="{{ s.penghasilan_ibu }}" class="form-control" required min="0" title="Penghasilan ibu (dalam angka)">
						  </div>
						</div>

						<div class="mb-2 row">
						  <label for="asal_sekolah_{{ s.nis }}" class="col-sm-4 col-form-label">Asal Sekolah</label>
						  <div class="col-sm-8">
							<input type="text" id="asal_sekolah_{{ s.nis }}" name="asal_sekolah" value="{{ s.asal_sekolah }}" class="form-control" required maxlength="30" title="Nama sekolah asal siswa">
						  </div>
						</div>

						<div class="mb-3 row">
						  <label for="id_status_{{ s.nis }}" class="col-sm-4 col-form-label">Status</label>
						  <div class="col-sm-8">
							<select name="id_status" id="id_status_{{ s.nis }}" class="form-control form-select" required>
							  {% for st in status_list %}
							  <option value="{{ st.id_status }}" {% if s.status_rel.status == st.status %} selected {% endif %}>{{ st.status }}</option>
							  {% endfor %}
							</select>
						  </div>
						</div>
            <!-- Tombol untuk membuka kolom password -->
            <button type="button" class="btn btn-secondary mb-2" data-bs-toggle="collapse" data-bs-target="#collapsePassword">
                Ubah Password
            </button>

            <!-- Bagian Password yang bisa di-collapse -->
            <div id="collapsePassword" class="collapse">
                <div class="col-md-12 mb-2">
                    <label for="password_{{ s.nis }}">Password</label>
                    <div class="input-group">
                        <input type="password" class="form-control" id="password_{{ s.nis }}" name="password" placeholder="Isi Password">
                        <button class="btn btn-outline-secondary toggle-password" type="button">
                            <i class="bi bi-eye"></i>
                        </button>
                    </div>
                </div>
            </div>
						<div class="modal-footer">
						  <button type="submit" id="tombol-edit-{{ s.nis }}" class="btn btn-success">Simpan</button>
						  <button type="button" class="btn btn-secondary" onclick="closeEdit('{{ s.nis }}')">Batal</button>
						</div>
					  </form>
					</div>

					</div>
				  </div>
				</div>
                {% endfor %}
		
			</tbody>
		</table>
		</div>
		</div>
		</div>
		</div>
		</div>
		</div>
<script>
 $('#myTable').DataTable();
// AJAX for Edit Siswa (PUT)
function openEdit(nis) {
    $(`#editModal-${nis}`).modal('show');
}
function closeEdit(nis) {
    $(`#editModal-${nis}`).modal('hide');
}

{% for s in siswa_list %}
document.getElementById("editForm-{{ s.nis }}").addEventListener("submit", function(event) {
        event.preventDefault();
        const form = this;
        const formData = new FormData(form);
        const data = {};
        formData.forEach((value, key) => {
            data[key] = value.trim ? value.trim() : value;
        });

        const tombol = document.getElementById("tombol-edit-{{ s.nis }}");
        tombol.disabled = true;
        tombol.innerHTML = '<div class="loader" id="loader"></div>';

        const baseUrl = window.location.origin + window.location.pathname;

        $.ajax({
            url: baseUrl + '/edit/{{ s.nis }}',
            type: 'PUT',
            contentType: 'application/json',
            dataType: 'json',
            data: JSON.stringify(data),
            success: function (response) {
                tombol.innerHTML = "Simpan";
                tombol.disabled = false;
                alert(response.msg || "Berhasil update siswa");
                window.location.reload();
            },
            error: function (xhr, status, error) {
                tombol.innerHTML = "Simpan";
                tombol.disabled = false;
                let errorTxt = "Server Error";
                if (xhr.responseJSON?.error) errorTxt = xhr.responseJSON.error;
                if (xhr.responseJSON?.msg) errorTxt = xhr.responseJSON.msg;
                alert(`Edit failed: ${errorTxt}`);
            }
        }); 
    });
{% endfor %}
</script>
{% endblock %}