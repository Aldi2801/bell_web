{% extends "layout.html" %}

{% block form_tambah %}
<div class="col-md-12 mb-3">
  <input type="number" class="form-control" name="nis" placeholder="NIS Siswa" required>
</div>

<div class="col-md-12 mb-3">
  <input type="number" class="form-control" name="id_ampu" placeholder="ID Ampu (Mapel-Guru-Semester)" required>
</div>

<div class="col-md-12 mb-3">
  <select name="jenis_penilaian" class="form-control" required>
    <option value="">Pilih Jenis Penilaian</option>
    <option value="UH">UH</option>
    <option value="Tugas">Tugas</option>
    <option value="UTS">UTS</option>
    <option value="UAS">UAS</option>
  </select>
</div>

<div class="col-md-12 mb-3">
  <input type="number" step="0.01" class="form-control" name="nilai" placeholder="Nilai" required>
</div>

<div class="col-md-12 mb-3">
  <input type="date" class="form-control" name="tanggal" required>
</div>
{% endblock %}

{% block content %}
<div class="page-titles">
  <div class="row">
    <div class="col-lg-8 col-md-6 col-12 align-self-center">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb mb-0 d-flex align-items-center">
          <li class="breadcrumb-item"><a href="/" class="link"><i class="ri-home-3-line fs-5"></i></a></li>
          <li class="breadcrumb-item active" aria-current="page">Data Penilaian</li>
        </ol>
      </nav>
      <h1 class="mb-0 fw-bold">Data Penilaian</h1>
    </div>
    {% if btn_tambah %}
    <div class="col-lg-4 col-md-6 d-md-flex align-items-center justify-content-end">
      <button type="button" class="btn btn-info d-flex align-items-center ms-2" data-bs-toggle="modal" data-bs-target="#tambahModal">
        <i class="ri-add-line me-1"></i> Tambah Data
      </button>
    </div>
    {% endif %}
  </div>
</div>

<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <h4>Data Penilaian</h4>
          <div class="table-responsive">
            <table id="myTable" class="table table-striped">
              <thead>
                <tr>
                  <th>NIS</th>
                  <th>Nama Siswa</th>
                  <th>ID Ampu</th>
                  <th>Jenis Penilaian</th>
                  <th>Nilai</th>
                  <th>Tanggal</th>
                  <th>Aksi</th>
                </tr>
              </thead>
              <tbody>
                {% for p in penilaian %}
                <tr>
                  <td>{{ p.nis }}</td>
                  <td>{{ p.siswa_rel.nama }}</td>
                  <td>{{ p.id_ampu }}</td>
                  <td>{{ p.jenis_penilaian }}</td>
                  <td>{{ p.nilai }}</td>
                  <td>{{ p.tanggal.strftime('%Y-%m-%d') if p.tanggal else '' }}</td>
                  <td>
                    <button type="button" class="btn btn-warning" onclick="openEditModal('{{ p.id_penilaian }}')">Edit</button>
                    <button type="button" class="btn btn-danger" onclick="deleteData('{{ p.id_penilaian }}')">Hapus</button>
                  </td>
                </tr>

                <!-- Modal Edit -->
                <div class="modal fade" id="editModal-{{ p.id_penilaian }}" tabindex="-1" aria-labelledby="editLabel" aria-hidden="true">
                  <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title" id="editLabel">Edit Penilaian</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Tutup"></button>
                      </div>
                      <div class="modal-body">
                        <form id="editForm-{{ p.id_penilaian }}">
                          <input type="hidden" name="id_penilaian" value="{{ p.id_penilaian }}">
                          <label>NIS:</label>
                          <input type="number" name="nis" value="{{ p.nis }}" class="form-control mb-3" required>
                          <label>ID Ampu:</label>
                          <input type="number" name="id_ampu" value="{{ p.id_ampu }}" class="form-control mb-3" required>
                          <label>Jenis Penilaian:</label>
                          <input type="text" name="jenis_penilaian" value="{{ p.jenis_penilaian }}" class="form-control mb-3" required>
                          <label>Nilai:</label>
                          <input type="number" step="0.01" name="nilai" value="{{ p.nilai }}" class="form-control mb-3" required>
                          <label>Tanggal:</label>
                          <input type="date" name="tanggal" value="{{ p.tanggal.strftime('%Y-%m-%d') if p.tanggal else '' }}" class="form-control mb-3" required>
                          <div class="modal-footer">
                            <button type="submit" id="tombol-edit-{{ p.id_penilaian }}" class="btn btn-success">Simpan</button>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                          </div>
                        </form>
                      </div>
                    </div>
                  </div>
                </div>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  $('#myTable').DataTable();

  {% for p in penilaian %}
  document.getElementById("editForm-{{ p.id_penilaian }}").addEventListener("submit", function(event) {
    event.preventDefault();
    const form = this;
    const formData = new FormData(form);
    const data = {};
    formData.forEach((value, key) => { data[key] = value.trim(); });

    const tombol = document.getElementById("tombol-edit-{{ p.id_penilaian }}");
    tombol.disabled = true;
    tombol.innerHTML = '<div class="spinner-border spinner-border-sm"></div>';

    const baseUrl = window.location.origin + window.location.pathname;

    $.ajax({
      url: baseUrl + '/edit/{{ p.id_penilaian }}',
      type: 'PUT',
      contentType: 'application/json',
      dataType: 'json',
      data: JSON.stringify(data),
      xhrFields: { withCredentials: true },
      success: function (response) {
        tombol.innerHTML = "Simpan";
        tombol.disabled = false;
        alert(response.msg || "Berhasil update penilaian");
        window.location.reload();
      },
      error: function (xhr) {
        tombol.innerHTML = "Simpan";
        tombol.disabled = false;
        let errorTxt = xhr.responseJSON?.msg || xhr.responseJSON?.error || "Server Error";
        alert("Edit gagal: " + errorTxt);
      }
    });
  });
  {% endfor %}
</script>
{% endblock %}
