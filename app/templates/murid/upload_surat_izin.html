{% extends "layout.html" %}
{% block form_tambah %}
<div class="col-md-12 mb-3">
  <label for="kbm">Pilih Pelajaran</label>
  <select id="kbm" name="id_kbm" class="form-control form-select" required>
    <option value="">-- pilih --</option>
    {% for g in data_kbm %}
      <option
        value="{{ g.id_kbm }}"
        data-tanggal="{{ g.tanggal.strftime('%Y-%m-%d') if g.tanggal else '' }}"
        data-materi="{{ g.materi or '' }}"
        data-sub_materi="{{ g.sub_materi or '' }}"
      >
        {{ (g.tanggal.strftime('%d/%m/%Y') ~ ' - ' if g.tanggal else '') ~ (g.materi or 'Tanpa materi') }}
      </option>
    {% endfor %}
  </select>
</div>

<div class="col-md-12 mb-3">
  <label for="tanggal">Tanggal</label>
  <input id="tanggal" class="form-control" disabled>
</div>

<div class="col-md-12 mb-3">
  <label for="materi">Materi</label>
  <input id="materi" class="form-control" disabled>
</div>

<div class="col-md-12 mb-3">
  <label for="sub_materi">Sub Materi</label>
  <input id="sub_materi" class="form-control" disabled>
</div>

<!-- Jika ingin ikut terkirim saat submit form, tambahkan hidden inputs -->
<input type="hidden" name="tanggal" id="tanggal_hidden">
<input type="hidden" name="materi" id="materi_hidden">
<input type="hidden" name="sub_materi" id="sub_materi_hidden">

<script>
  (function() {
    const sel = document.getElementById('kbm');
    const inTanggal = document.getElementById('tanggal');
    const inMateri = document.getElementById('materi');
    const inSub = document.getElementById('sub_materi');

    const hTanggal = document.getElementById('tanggal_hidden');
    const hMateri = document.getElementById('materi_hidden');
    const hSub = document.getElementById('sub_materi_hidden');

    function fill() {
      const opt = sel.selectedOptions[0];
      if (!opt) return;

      const tanggal = opt.dataset.tanggal || '';
      const materi = opt.dataset.materi || '';
      const sub = opt.dataset.sub_materi || '';

      inTanggal.value = tanggal;
      inMateri.value = materi;
      inSub.value = sub;

      if (hTanggal) hTanggal.value = tanggal;
      if (hMateri) hMateri.value = materi;
      if (hSub) hSub.value = sub;
    }

    sel.addEventListener('change', fill);
    // Isi awal (kalau default sudah terpilih)
    fill();
  })();
</script>
{% endblock %}
{% block content %}
<div class="page-titles">
  <div class="row">
    <div class="col-lg-8 col-md-6 col-12 align-self-center">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb mb-0 d-flex align-items-center">
          <li class="breadcrumb-item">
            <a href="index.html" class="link">
              <i class="ri-home-3-line fs-5"></i>
            </a>
          </li>
          <li class="breadcrumb-item active" aria-current="page">Data {{title}}</li>
        </ol>
      </nav>
      <h1 class="mb-0 fw-bold">Data {{title}}</h1>
    </div>
	{% if btn_tambah %}
    <div class="col-lg-4 col-md-6 d-md-flex align-items-center justify-content-end">
		<button type="button" class="btn btn-info d-flex align-items-center ms-2" class="logout-button" data-bs-toggle="modal" data-bs-target="#tambahModal">
		  <i class="ri-add-line me-1"></i> Tambah Data
		</button>
    </div>
    {% endif %}
  </div>
</div>
<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
            <h2>Data Kehadiran Izin</h2>
            <p>Berikut adalah data kehadiran Izin Anda. Silakan periksa dan pastikan surat izin yang tercantum sudah benar.</p>
            <div class="table-responsive">
<table id="myTable"class="table table-striped">
    <thead class="table-info">
        <tr>
            <th style="white-space: nowrap;">Nama Murid</th>
            <th>Tanggal</th>
            <th>Mata Pelajaran</th>
            <th>Nama Kelas</th>
            <th>Tingkat</th>
            <th>Materi</th>
            <th>keterangan</th>
            <th>Surat Izin</th>
        </tr>
    </thead>
    <tbody>
      {% if data_kehadiran %}
  {% for i in data_kehadiran %}
    <tr>
      <td>{{ i.siswa_rel.nama }}</td>
      <td>{{ i.kbm_rel.tanggal if i.kbm_rel else '-' }}</td>
      <td>
        {{ i.kbm_rel.ampu_rel.mapel_rel.nama_mapel if i.kbm_rel and i.kbm_rel.ampu_rel and i.kbm_rel.ampu_rel.mapel_rel else '-' }}
      </td>
      <td>{{ i.nama_kelas }}</td>
      <td>{{ i.tingkat }}</td>
      <td>{{ i.kbm_rel.materi if i.kbm_rel else '-' }}</td>
      <td>{{ i.keterangan_rel.keterangan if i.keterangan_rel else '-' }}</td>
      <td>
          {% if not i.surat_izin or i.surat_izin == 'null' %}
          <span>upload surat izin<span><br>
          <form action="/murid/surat_izin_simpan" method="POST" enctype="multipart/form-data">
            <input type="hidden" name="id_kehadiran" value="{{ i.id_kehadiran }}">
            <input type="hidden" name="id_siswa" value="{{ i.id_siswa }}">
            <input type="file" name="surat_izin" accept=".pdf,.jpg,.jpeg,.png"><br>
            <button type="submit" class="btn btn-success btn-sm">Upload</button>
        </form>

          {% else %}
          <span>Anda sudah mengupload surat izin</span><br>
          <a href="/static/surat_izin/{{i.surat_izin}}" target="_blank" class="btn btn-primary btn-sm">Download Surat Izin</a><br>
          <span>Upload ulang apabila ingin menganti</span>
          <form action="/murid/surat_izin_simpan" method="POST" enctype="multipart/form-data">
            <input type="hidden" name="id_kehadiran" value="{{ i.id_kehadiran }}">
            <input type="hidden" name="id_siswa" value="{{ i.id_siswa }}">
            <input type="file" name="surat_izin" accept=".pdf,.jpg,.jpeg,.png">
            <button type="submit" class="btn btn-success btn-sm">Upload </button>
          </form>
          {% endif %}
      </td>
    </tr>
  {% endfor %}
{% else %}
  <tr>
    <td colspan="7" class="text-center">Tidak ada data kehadiran.</td>
  </tr>
{% endif %}


    </tbody>
</table>
</div>
        </div>
      </div>
    </div>
  </div>
<script>
 $('#myTable').DataTable();
 </script>
{% endblock %}